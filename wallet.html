<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <title>Wallet Minuti</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root { color-scheme: dark; }
    body { background:#0b0d12; color:#e9eef5; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif; }
    .wrap { max-width:820px; margin:40px auto; padding:0 16px; }
    .card { background:#101522; border:1px solid #1a2030; border-radius:12px; padding:16px; margin-bottom:16px; }
    input, button { padding:10px; border-radius:8px; border:1px solid #303646; background:#0f1420; color:#e9eef5; }
    button { background:#7c6dff; border:0; cursor:pointer; font-weight:600; }
    .label { font-size:14px; margin-bottom:6px; display:block; }
    table { width:100%; border-collapse:collapse; }
    th, td { border-bottom:1px solid #1a2030; padding:6px; font-size:14px; }
    .err { color:#ff6b6b; }
    .ok { color:#2dd39c; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Wallet minuti</h1>
    <div class="card">
      <label class="label">Email usata nei pagamenti</label>
      <input id="email" placeholder="tu@email.com">
      <button id="go">Vedi saldo</button>
      <span id="msg"></span>
    </div>

    <div class="card">
      <h2>Saldo</h2>
      <p>Minuti: <strong id="minutes">0</strong></p>
      <p>Ordini: <strong id="orders">0</strong></p>
      <p>Livello: <strong id="level">Base</strong></p>
    </div>

    <div class="card">
      <h2>Storico (dati Stripe)</h2>
      <table>
        <thead><tr><th>Session</th><th>Minuti</th></tr></thead>
        <tbody id="history"></tbody>
      </table>
    </div>

    <p><a href="/index.html" style="color:#fff;opacity:.6;">← Torna al catalogo</a></p>
  </div>
  <script>
    async function loadBalance(email){
      const msg = document.getElementById('msg');
      msg.textContent = 'carico…';
      msg.className = '';
      const r = await fetch('/.netlify/functions/wallet?email='+encodeURIComponent(email));
      const out = await r.json().catch(()=>({}));
      if (!r.ok || out.error){
        msg.textContent = out.error || ('HTTP '+r.status);
        msg.className = 'err';
        return;
      }
      msg.textContent = 'OK';
      msg.className = 'ok';
      document.getElementById('minutes').textContent = out.minutes ?? 0;
      document.getElementById('orders').textContent = out.orders ?? 0;
      document.getElementById('level').textContent = out.level ?? 'Base';

      const tb = document.getElementById('history');
      tb.innerHTML = '';
      (out.sessions||[]).forEach(s=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${s.id}</td><td>${s.minutes}</td>`;
        tb.appendChild(tr);
      });
      if (!(out.sessions||[]).length){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="2" style="opacity:.6;">Nessun pagamento trovato</td>`;
        tb.appendChild(tr);
      }
    }
    document.getElementById('go').addEventListener('click',()=>{
      const email = document.getElementById('email').value.trim();
      if (!email){
        document.getElementById('msg').textContent = 'inserisci email';
        document.getElementById('msg').className = 'err';
        return;
      }
      loadBalance(email);
    });
  </script>
</body>
</html>
